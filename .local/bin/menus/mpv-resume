#!/usr/bin/env bash
# For this script to work you need to set
#   `write-filename-in-watch-later-config`
# option in the mpv.conf and start videos by specifying the full path.

cd ~/.config/mpv/watch_later || exit

while read -ra HistFiles; do
	for HistFile in ${HistFiles[1]}; do
		while IFS='# ' read -r _ File; do
			if [[ -f "$File" ]]; then
				Hist+=("$File")
			elif [[ $File =~ ^http.* ]]; then
				Hist+=("$File")
			else
				rm "$HistFile"
			fi
			break
		done < "$HistFile"
	done
done < <(find . -type f -printf "%T+ %P\n" | sort -r)

[[ -z "$HistFile" ]] && exit

while read -r PlayThis; do
	[[ -n "$PlayThis" ]] || break

	for HistItem in "${Hist[@]}"; do
		if [[  $HistItem == *"$PlayThis" ]]; then
			if [[ -f "$HistItem" ]]; then
				find /tmp/mpvsocket[0-9]* -type s 2>/dev/null && mpvc quit
				sleep .2
				mpvc "$HistItem"
			elif [[ $HistItem =~ ^http.*"$PlayThis" ]]; then
				ym "$HistItem"
			fi
			break
		fi
	done
done < <(printf '%s\n' "${Hist[@]##*/}" | dmenu -i -l 5 -p )

