#!/bin/sh
# A simple shell script to manage clipboard with rofi/fzf.
# Dependencies: greenclip, rofi/dmenu, fzf, xclip, xsel.

pidof greenclip >/dev/null || setsid -f greenclip daemon >/dev/null 2>&1

clipin() { xargs -r -d'\n' -I '{}' greenclip print '{}' ;}

wrofi() {
	# Display content of primary clipboard as rofi message:
	prim=$(printf ' Primary:   %s' "$(xclip -o | sed '/^$/d;s/^[ \t]*//')" |
		sed 's/\&/\&amp\;/g;s/</\&lt\;/g;s/>/\&gt\;/g' | head -n1 )
	[ ${#prim} -ge 87 ] && prim=$(printf '%s' "$prim" | cut -c -85)..

	# Because we can't use `-mesg` with `-modi`:
	greenclip print | sed '/^$/d' | rofi -dmenu -i -l 10 -width 60 \
		-p Clipboard -mesg "<span color='#a89984'>$prim</span>" | clipin

	# rofi -modi "clipboard:greenclip print" -show clipboard \
	# -run-command '{cmd}' -lines 10 -width 60
}

wdmenu() {
	greenclip print | sed '/^$/d'| dmenu -i -l 10 -p Clipboard | clipin
}

wfzf() {
	greenclip print | sed '/^$/d' | fzf -e | clipin
}

case $1 in
	cfg)
		killall greenclip
		$EDITOR ~/.config/greenclip.cfg
		setsid -f greenclip daemon >/dev/null 2>&1
	;;
	rld)
		killall greenclip
		setsid -f greenclip daemon >/dev/null 2>&1
	;;
	clear)
		xsel -bc; xsel -c
		killall greenclip
		rm -rf ~/.cache/greenclip/history ~/.cache/greenclip/image
		setsid -f greenclip daemon >/dev/null 2>&1
	;;
	keep)
		$EDITOR ~/.cache/greenclip/staticHistory
	;;
	selpaste|sp)
		xdotool type --clearmodifiers "$(xclip -o -selection)"
	;;
	seltoclip|sc)
		xclip -o -selection | xclip -selection clipboard
	;;
	[1-9])
		greenclip print | sed -n "$1"p | clipin
		xdotool key --clearmodifiers Ctrl+Shift+v
	;;
	"")
		{ [ -t 2 ] && wfzf ;} || wrofi
	;;
	*)
		cat <<-EOF
		Usage: $(basename "$0") []
		[]   ==>     [cfg, clear, keep, rld, selpaste|sp, seltoclip|sc]
		EOF
esac

