#!/bin/sh
# A simple shell script to manage clipboard with rofi/fzf.
# Dependencies: greenclip, rofi/dmenu, fzf, xclip, xsel.

if ! pgrep -x greenclip >/dev/null; then
	nohup greenclip daemon >/dev/null 2>&1 &
fi

wrofi() {
	# Display content of primary clipboard as rofi message:
	prim=$(printf 'Primary: %s' "$(xclip -o | sed '/^$/d;s/^[ \t]*//')" |
		sed 's/\&/\&amp\;/g;s/</\&lt\;/g;s/>/\&gt\;/g' | head -n1 )
	[ ${#prim} -ge 87 ] && prim=$(printf '%s' "$prim" | cut -c -87)..

	# Because we can't use `-mesg` with `-modi`:
	greenclip print | sed '/^$/d' | rofi -dmenu -i -l 10 -width 60 \
		-p Clipboard -mesg "<span color='#a89984'>$prim</span>" |
		xargs -r -d'\n' -I '{}' greenclip print '{}'

	# rofi -modi "clipboard:greenclip print" -show clipboard \
	# -run-command '{cmd}' -lines 10 -width 60
}

wdmenu() {
	greenclip print | sed '/^$/d'| dmenu -i -l 10 -p Clipboard |
		xargs -r -d'\n' -I '{}' greenclip print '{}'
}

wfzf() {
	greenclip print | sed '/^$/d' | fzf -e |
		xargs -r -d'\n' -I '{}' greenclip print '{}'
}

case $1 in
	cfg)
		killall greenclip
		$EDITOR ~/.config/greenclip.cfg
		nohup greenclip daemon >/dev/null 2>&1 &
	;;
	rld)
		killall greenclip
		nohup greenclip daemon >/dev/null 2>&1 &
	;;
	clear)
		xsel -bc; xsel -c
		killall greenclip
		rm ~/.cache/greenclip.history
		nohup greenclip daemon >/dev/null 2>&1 &
	;;
	keep)
		$EDITOR ~/.cache/greenclip.staticHistory
	;;
	selpaste|sp)
		xdotool type --clearmodifiers "$(xclip -o -selection)"
	;;
	seltoclip|sc)
		xclip -o -selection | xclip -selection clipboard
	;;
	"")
		{ [ -t 2 ] && wfzf ;} || wrofi
	;;
	*)
		cat <<-EOF
		Usage:
		‎  $(basename "$0") [] [OPTION]
		‎        [cfg, clear, keep, rld, selpaste|sp, seltoclip|sc]
		EOF
esac

