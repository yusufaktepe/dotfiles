#!/bin/sh

AW=$(xdotool getactivewindow)
AW_CLASS=$(xprop -id "$AW" | awk -F'"' '/WM_CLASS/{print tolower($4)}')

_crow() {
	if pidof crow >/dev/null; then
		if wmctrl -lx | grep -q "crow.Crow Translate"; then
			wmctrl -x -a "crow.Crow Translate" && i3-msg kill >/dev/null
		else
			dbus-send --type=method_call --dest=io.crow_translate.CrowTranslate \
				/io/crow_translate/CrowTranslate/MainWindow \
				io.crow_translate.CrowTranslate.MainWindow.open
		fi
	else
		crow >/dev/null 2>&1 &
	fi
}

_vbox() {
	if VBoxManage list vms runningvms | grep -q "$1"; then
		if [ "$AW_CLASS" = "virtualbox machine" ]; then
			i3-msg "workspace back_and_forth" >/dev/null
		else
			i3-msg "[class=(?i)VirtualBox title=(?i)$1] focus" >/dev/null
		fi
	else
		VBoxManage startvm "$1" >/dev/null 2>&1 &
	fi
}

for arg in "$@"; do
	case $arg in
		-c) opt_class=$2 ;;
		-e) opt_exec=$2 ;;
		-f) opt_flags=$2 ;;
		-p) opt_proc=$2 ;;
		--toggle) opt_toggle=${2:-true} ;;
		crow) _crow; exit ;;
		vbox) _vbox "$2"; exit ;;
	esac
	shift
done

case $opt_exec in
	brave*) opt_class=brave-browser ;;
	*chrome*) opt_proc=chrome; opt_class=google-chrome ;;
	doublecmd) opt_flags=--no-splash ;;
	opera*) opt_flags=--start-maximized ;;
	vivaldi*) opt_proc=vivaldi-bin; opt_flags=--start-maximized ;;
esac

[ -n "$opt_proc" ] && proc=$opt_proc || proc=$opt_exec
[ -z "$opt_class" ] && opt_class=$opt_exec
[ -n "$opt_flags" ] && opt_exec="$opt_exec $opt_flags"

if [ -n "$opt_class" ] && [ -n "$opt_exec" ]; then
	if pgrep -x "$proc" >/dev/null; then
		if [ "$AW_CLASS" = "$opt_class" ]; then
			if [ "$opt_toggle" = scratchpad ]; then
				i3-msg "[class=\"(?i)$opt_class\"] move scratchpad" >/dev/null
			elif [ "$opt_toggle" ]; then
				i3-msg kill >/dev/null
				[ "$opt_class" = pavucontrol ] && pkill -SIGRTMIN+10 i3blocks
				[ "$opt_class" = arandr ] && setbg
			else
				i3-msg "workspace back_and_forth" >/dev/null
			fi
		else
			i3-msg "[class=\"(?i)$opt_class\"] focus" >/dev/null
		fi
	else
			$opt_exec >/dev/null 2>&1 &
	fi
fi

