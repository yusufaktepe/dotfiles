#!/bin/sh

update_bar() {
	if pidof -q i3blocks; then
		pkill -RTMIN+10 i3blocks
	elif pidof -q polybar; then
		polybar-msg action "#brightness.hook.0" >/dev/null
	else
		return
	fi
}

notify() {
	IFS=, read -r _ _ _ brightness _ <<-+++
		"$(brightnessctl --machine-readable info)"
	+++

	dunstify \
		-a volbright \
		-i "display-brightness" \
		-t 1500 \
		-h int:value:"$brightness" \
		-h string:synchronous:brightness \
		-r 1000 \
		"$brightness"
}

kboff() {
	LKB=/sys/class/leds/tpacpi::kbd_backlight/brightness
	LPWR=/sys/class/leds/tpacpi::power/brightness

	for L in $LKB $LPWR; do
		[ -e "$L" ] || continue
		read -r StatusL < "$L"
		[ $StatusL != 0 ] && printf 0 > "$L"
	done
	for LC in /sys/class/leds/*capslock/brightness; do
		[ -e "$LC" ] || continue
		printf 1 > "$LC"; printf 0 > "$LC"
	done
}


case $1 in
	inc) brightnessctl set "+${2:-5}%" >/dev/null && { notify; update_bar ;} ;;
	dec) brightnessctl set "${2:-5}%-" >/dev/null && { notify; update_bar ;} ;;
	set) brightnessctl set "${2:-27}%" >/dev/null && { notify; update_bar ;} ;;
	kboff) kboff ;;
	off) xset dpms force off; kboff ;;
esac

